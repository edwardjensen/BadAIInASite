# .github/workflows/ci.yml
# Replaces deploy.yml - builds and tests but does NOT deploy
name: Continuous Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/badaiinasite

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.changes.outputs.should-build }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check for app file changes
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        elif git diff --name-only HEAD~1 HEAD | grep -E '^(src/|public/|package\.json|Dockerfile|settings\.conf|menu\.json)'; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        else
          echo "should-build=false" >> $GITHUB_OUTPUT
        fi

  test-and-build:
    needs: check-changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    if: needs.check-changes.outputs.should-build == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch,suffix=-dev
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          # Note: No 'latest' tag for development builds

    - name: Build and push development image
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: linux/amd64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run tests
      run: |
        echo "🧪 Running comprehensive tests..."
        
        # Get the first built image tag
        IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
        echo "Testing image: $IMAGE_TAG"
        
        # 1. Container Health Check
        echo "🏥 Testing container health..."
        CONTAINER_ID=$(docker run -d --name test-container $IMAGE_TAG)
        sleep 10  # Give container time to start
        
        # Check if container is running
        if docker ps | grep -q test-container; then
          echo "✅ Container started successfully"
        else
          echo "❌ Container failed to start"
          docker logs test-container
          exit 1
        fi
        
        # 2. Basic HTTP Response Test (if your app serves HTTP)
        echo "🌐 Testing HTTP response..."
        # Uncomment and modify for your app's actual port/endpoint:
        # if curl -f http://localhost:8080/health > /dev/null 2>&1; then
        #   echo "✅ HTTP health check passed"
        # else
        #   echo "❌ HTTP health check failed"
        #   exit 1
        # fi
        
        # 3. Environment Variable Tests
        echo "🔧 Testing environment handling..."
        docker exec test-container printenv | grep -E "(NODE_ENV|PORT)" || true
        
        # 4. Container Resource Usage
        echo "📊 Checking resource usage..."
        docker stats test-container --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
        
        # 5. Security Scan (basic)
        echo "🔒 Running basic security checks..."
        # Check for common security issues
        if docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
           aquasec/trivy:latest image --severity HIGH,CRITICAL $IMAGE_TAG > /dev/null 2>&1; then
          echo "✅ No critical security vulnerabilities found"
        else
          echo "⚠️  Security scan completed (check logs for details)"
        fi
        
        # Cleanup
        docker stop test-container
        docker rm test-container
        
        echo "✅ All tests completed successfully"

  deployment-ready:
    needs: [check-changes, test-and-build]
    runs-on: ubuntu-latest
    if: |
      !cancelled() && 
      needs.check-changes.outputs.should-build == 'true' &&
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push'

    steps:
    - name: Deployment readiness
      run: |
        echo "🚀 Code is ready for deployment!"
        echo ""
        echo "📋 To deploy to production:"
        echo "   1. Create a release tag: git tag v1.0.0"
        echo "   2. Push the tag: git push origin v1.0.0" 
        echo "   3. The release workflow will build and deploy automatically"
        echo ""
        echo "💡 Development image available at:"
        echo "   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-dev"